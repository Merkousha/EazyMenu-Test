@using EazyMenu.Application.Features.Tenants.Common
@using EazyMenu.Domain.Aggregates.Tenants
@using System.Globalization
@{
    ViewData["Title"] = "داشبورد";
    var subscription = ViewBag.Subscription as SubscriptionDetailsDto;
    var persianCulture = new CultureInfo("fa-IR");
}

<div class="row">
    <div class="col-md-8">
        <div class="alert alert-success" role="alert">
            <h4 class="alert-heading">خوش آمدید، @ViewBag.UserName!</h4>
            <p>شما با موفقیت وارد سیستم شدید.</p>
            <hr>
            <p class="mb-0">
                <strong>نقش:</strong> @ViewBag.UserRole
            </p>
        </div>
    </div>

    @if (subscription is not null)
    {
        <div class="col-md-4">
            <div class="card @(subscription.Status == SubscriptionStatus.Active ? "border-success" : "border-warning")">
                <div class="card-header @(subscription.Status == SubscriptionStatus.Active ? "bg-success text-white" : "bg-warning")">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-award"></i> اطلاعات اشتراک
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        <strong>پلن:</strong> 
                        @if (subscription.IsTrial)
                        {
                            <span class="badge bg-info">آزمایشی</span>
                        }
                        @subscription.Plan.ToString()
                        <br/>
                        
                        <strong>وضعیت:</strong>
                        @switch (subscription.Status)
                        {
                            case SubscriptionStatus.Active:
                                <span class="badge bg-success">فعال</span>
                                break;
                            case SubscriptionStatus.Expired:
                                <span class="badge bg-danger">منقضی شده</span>
                                break;
                            case SubscriptionStatus.Suspended:
                                <span class="badge bg-warning">معلق</span>
                                break;
                            case SubscriptionStatus.Cancelled:
                                <span class="badge bg-secondary">لغو شده</span>
                                break;
                            default:
                                <span class="badge bg-secondary">@subscription.Status.ToString()</span>
                                break;
                        }
                        <br/>
                        
                        @if (subscription.EndDateUtc.HasValue)
                        {
                            var endDate = subscription.EndDateUtc.Value.ToString("yyyy/MM/dd", persianCulture);
                            var daysRemaining = (subscription.EndDateUtc.Value - DateTime.UtcNow).Days;
                            
                            <strong>اعتبار تا:</strong> @endDate
                            <br/>
                            
                            @if (daysRemaining > 0 && daysRemaining <= 7)
                            {
                                <div class="alert alert-warning mt-2 mb-0 py-1 px-2 small">
                                    <i class="bi bi-exclamation-triangle"></i> 
                                    @daysRemaining روز تا پایان اشتراک باقی مانده است
                                </div>
                            }
                            else if (daysRemaining > 7)
                            {
                                <small class="text-muted">@daysRemaining روز باقی مانده</small>
                            }
                        }
                        else
                        {
                            <small class="text-muted">اشتراک نامحدود</small>
                        }
                    </p>
                    
                    @if (subscription.DiscountPercentage.HasValue && !string.IsNullOrEmpty(subscription.DiscountCode))
                    {
                        <div class="alert alert-info mt-2 mb-0 py-1 px-2 small">
                            <i class="bi bi-tag"></i> 
                            @subscription.DiscountPercentage.Value.ToString("P0") تخفیف با کد @subscription.DiscountCode
                        </div>
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="col-md-4">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-exclamation-triangle"></i> اطلاعات اشتراک
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text text-danger">
                        اطلاعات اشتراک در دسترس نیست. لطفاً با پشتیبانی تماس بگیرید.
                    </p>
                </div>
            </div>
        </div>
    }
</div>

<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-menu-button-wide"></i> مدیریت منو</h5>
                <p class="card-text">ایجاد و ویرایش منوی رستوران</p>
                <a asp-controller="Menus" asp-action="Index" class="btn btn-light">مشاهده منوها</a>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-receipt"></i> سفارش‌ها</h5>
                <p class="card-text">مدیریت و پیگیری سفارشات</p>
                <a asp-controller="Orders" asp-action="Index" class="btn btn-light">مشاهده سفارش‌ها</a>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-calendar-check"></i> رزرو میز</h5>
                <p class="card-text">مدیریت رزرو میزهای رستوران</p>
                <a asp-controller="Reservations" asp-action="Index" class="btn btn-light">مشاهده رزروها</a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-chat-dots"></i> گزارش پیامک‌ها</h5>
                <p class="card-text">مشاهده لاگ‌های ارسال پیامک</p>
                <a asp-controller="Notifications" asp-action="SmsLogs" class="btn btn-light">مشاهده گزارش‌ها</a>
            </div>
        </div>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
